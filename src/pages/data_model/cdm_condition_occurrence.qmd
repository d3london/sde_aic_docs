
## CONDITION_OCCURRENCE

### source.{source_table} (BRONZE)

Structured data sources for patient conditions or diagnoses will generally always include:

| Table                                  | Type            |
|----------------------------------------|-----------------|
| Commissioning Datasets                 | Legacy + Live          |
| Clinical Coding activity outputs | Legacy + Live          |
| Electronic health record system problem lists | Legacy + Live  |
| Specialty system problem lists        | Legacy + Live   |

Tables are loaded to the database in batches, or through incremental ingestion via connection to a source database.

### bronze.stg_{source}__{entity} (BRONZE)

Each data source is first staged in `stg_{source}__{entity}`. This may include column renaming, SELECT and UNION statements, and edge case handling.

### silver.int_condition_occurrence (SILVER)

Different data sources are UNIONED into a minimum common dataset for representing the occurrence of conditions, and attached qualifiers.      

```{mermaid}
---
title: Condition Occurrence Intermediate Table
---
erDiagram
    int_condition_occurrence {
        condition_occurrence_id integer "[PK] autogenerated identifier"
        person_id integer "[FK person]"
        condition_source_value varchar "condition code as represented in source"
        condition_source_value_name varchar "condition name as represented in source"
        domain_id varchar "constrained by possible omop domains"
        vocabulary_id "id of source vocab"
        condition_diagnosis_order integer "for commissioning data, the diagnosis order given in source"
        condition_parent_id integer "[FK] if diagnoses are clustered, e.g. in a problem list, this gives the parent"
        condition_start_date date
        condition_start_datetime timestamp
        condition_end_date date
        condition_end_datetime timestamp
        condition_type_concept_id integer "[FK not null] categorisation through NHS systems - see notes"
        condition_status_concept_id integer "[set as null]"
        stop_reason varchar20 "[set as null]"
        provider_id integer "[set as null]"
        visit_occurrence_id integer "[FK]"
        visit_detail_id integer "[set as null]"      
        condition_source_value varchar50 "condition code as represented in source"
        condition_source_value_name varcharMAX "[NEW] condition name as represented in source"
        condition_source_concept_id integer "[set as null]"          
        condition_source_vocabulary_id varchar20 "[FK NEW] OMOP vocabulary id representing the source concept"
        condition_status_source_value varchar50 "[set as null]"
        source_system_provenance varchar50 "[NEW] name of specific system from which source table was ingested"
        source_table_provenance varchar50 "[NEW] source table name"
        source_row_id varchar50 "[NEW] unique row id for the single concept that is generated at ingestion"
    }
```

### silver.mrt_condition_occurrence (SILVER)

This is the transformed version of ingested person and demographic tables. This table is wider than the OMOP data model can be further constrained to transform into vanilla OMOP. It contains the following differences from OMOP:

- Standardised concept codes/names are surfaced, and indexed, to enable user-friendly exploration and visualisation without the need for large joins;
- Additional demographic fields for UK specific deprivation are included; 
- OMOP CDM 5.4 columns that are not relevant to the NHS, or to intended purposes, are initialised, but we do not populate. They remain empty when carried into omop.person;
- To populate this, logic is applied to surface the most recent and reliable dimensions based on intermediate tables.    

```{mermaid}
---
title: OMOP_EXT Condition Occurrence
---
erDiagram
    mrt_condition_occurrence {
        condition_occurrence_id integer "[PK not null] autogenerated identifier"
        person_id integer "[FK not null]"
        condition_concept_id integer "[FK not null]"
        condition_concept_code varchar50 "[NEW] standard OMOP concept code"
        condition_concept_name varcharMAX "[NEW] standard OMOP concept name"
        condition_concept_vocabulary_id varchar20 "[FK NEW] OMOP vocabulary id representing the standard concept"
        condition_diagnosis_order integer "[NEW] for commissioning data only, the diagnosis order given in source"
        condition_start_date date "[not null]"
        condition_start_datetime timestamp "[set as null]"
        condition_end_date date
        condition_end_datetime timestamp "[set as null]"
        condition_type_concept_id integer "[FK not null] categorisation through NHS systems - see notes"
        condition_status_concept_id integer "[set as null]"
        stop_reason varchar20 "[set as null]"
        provider_id integer "[set as null]"
        visit_occurrence_id integer "[FK]"
        visit_detail_id integer "[set as null]"      
        condition_source_value varchar50 "condition code as represented in source"
        condition_source_value_name varcharMAX "[NEW] condition name as represented in source"
        condition_source_concept_id integer "[set as null]"          
        condition_source_vocabulary_id varchar20 "[FK NEW] OMOP vocabulary id representing the source concept"
        condition_status_source_value varchar50 "[set as null]"
        source_system_provenance varchar50 "[NEW] name of specific system from which source table was ingested"
        source_table_provenance varchar50 "[NEW] source table name"
        source_row_id varchar50 "[NEW] unique row id for the single concept that is generated at ingestion"
    }
```

### omop.person (GOLD, OMOP CDM 5.4)

Central identity management for all persons in the OMOP data model. It contains records that uniquely identify each person or patient, and some demographic information.
```{mermaid}
---
title: OMOP Person Table
---
erDiagram
    person {
        person_id integer "[PK not null]"
        gender_concept_id integer "[not null]"
        year_of_birth integer "[not null]"
        month_of_birth integer
        day_of_birth integer
        birth_datetime timestamp
        race_concept_id integer "[not null] race or ethnicity"
        ethnicity_concept_id integer "[not null] US-specific hispanic vs non-hispanic"
        location_id integer "patient physical address"
        provider_id integer "GP who is primary care provider"
        care_site_id integer "GP surgery for primary care"
        person_source_value varchar50 "nhs number where available"
        gender_source_value varchar50 "biological sex as represented in source"
        gender_source_concept_id integer "mapping to omop, but often empty"
        race_source_value varchar50 "race or ethnicity as represented in source"
        race_source_concept_id integer "mapping to omop, but often empty"
        ethnicity_source_value varchar50 "US-specific as represented in source"
        ethnicity_source_concept_id integer "mapping to omop, but often empty"
    }
```
