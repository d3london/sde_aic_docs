
## DRUG_EXPOSURE

### source.{source_table} (BRONZE)

Structured data sources for medications prescribing and dispensing will generally always include:

| Table                                  | Type            |
|----------------------------------------|-----------------|
| Electronic prescribing and administration                | Legacy + Live          |
| Pharmacy dispensing | Legacy + Live          |

Tables are loaded to the database in batches, or through incremental ingestion via connection to a source database.

### bronze.base_ or stg_{source}__{entity} (BRONZE)

Data sources are staged as `stg_{source}__{entity}` (if necessary, with an initial step of `base_{source}__{entity}` prior to unioning). This may include column renaming and edge case handling.

### silver.int_drug_exposure_dispensing (SILVER)

Different data sources are UNIONED into a common dataset for representing medications that are dispensed from pharmacy to inpatient, outpatient, and to-take-away. This table does not contain data from specialty specific systems such as chemotherapy.

Patients must first be assigned a `person_uuid`. Where dispensing is attached to a particular hospital admission or attendance, these `spells` or `attendances` must first be assigned a `visit_occurrence_id`.

The column `drug_type` helps interpretation, and will indirectly map to OMOP drug_type_concept_id:
- `dispensing_unknown` indicates a drug that was ordered for dispensing from pharmacy, but the data source does not provide information to indicate whether this dispensing was carried out;
- `dispensing_dispensed` indicates a drug that was ordered and dispensed to patient from pharmacy;
- `dispensing_notdispensed` indicates a drug that was ordered for dispensing, but ultimately not dispensed.

This table gives flexibility for highly detailed source systems, including possiblities for recording formulations and prescribed doses and instructions for each drug.

```{mermaid}
---
title: Drug Exposure (Dispensing) Intermediate Table
---
erDiagram
    int_drug_exposure_dispensing {
        drug_exposure_id integer "[PK] autogenerated identifier"
        person_uuid uuid "[FK ext_person] standardised unique person id"
        drug_exposure_start_date date
        drug_exposure_start_datetime datetime
        drug_exposure_end_date date
        drug_exposure_end_datetime datetime        
        drug_source_value varchar "drug code as represented in source"
        drug_source_value_name varchar "drug name as represented in source - may include formulation"
        domain_id varchar "most relevant omop domain"
        source_vocabulary_id varchar "id of source vocab"
        drug_type varchar "status of drug, dispensing_unknown, dispensing_dispensed, dispensing_notdispensed"
        drug_location varchar "free text for location context - e.g. ward name, or inpatient, outpatient, TTA"
        drug_desc varchar "additional free text for further qualification, e.g. resupply, new supply"
        route_source_value varchar "route as represented in the source"
        item_formulation_source_value varchar "if available, best string that fully describes item formulation, e.g. 500mg tablet"
        item_strength_quantity_source_value float "strength of one item of drug e.g. 500"
        item_strength_units_source_value varchar "units given to one item e.g. mg"        
        item_type_source_value varchar "type of item, e.g. tablet"
        dose_instruct_source_value varchar "if available, best string that captures dosing instructions, e.g. 1g four times a day"
        dose_quantity_source_value float "dose prescribed e.g. 1"
        dose_unit_source_value varchar "units given to the prescribed dose e.g. g"
        dose_frequency_source_value varchar "dosing instructions e.g. four times a day"
        days_supply integer "how many days given"
        stop_reason varchar "stop reason where given in source"
        sig varchar "additional verbatim instructions for drug"
        visit_occurrence_id integer "[FK ext_visit_occurrence] standardised unique visit id"
        source_table_provenance varchar "source table name"
        source_row_id uuid "unique row id for the single concept that is generated at ingestion"
    }
```

### silver.int_drug_exposure_prescribing (SILVER)

Different data sources are UNIONED into a common dataset for representing medications that are prescribed +/- administered while attending a hospital location. This table does not contain data from specialty specific systems such as chemotherapy.

Patients must first be assigned a `person_uuid`. Where dispensing is attached to a particular hospital admission or attendance, these `spells` or `attendances` must first be assigned a `visit_occurrence_id`.

The column `drug_type` helps interpretation, and will indirectly map to OMOP drug_type_concept_id:
- `prescribing_unknown` indicates a drug that was prescribed, but the data source does not provide information to indicate whether the drug was administered or not
- `prescribing_administered` indicates that a drug was prescribed and administered to the patient
- `presribing_notadministered` indicates that a drug was prescribed but was explicitly cancelled or otherwise not given

This table also gives flexiblity for inputting special prescription/administration types, such as infusions.
```{mermaid}
---
title: Drug Exposure (Prescribing) Intermediate Table
---
erDiagram
    int_drug_exposure_prescribing {
        drug_exposure_id integer "[PK] autogenerated identifier"
        person_uuid uuid "[FK ext_person] standardised unique person id"
        drug_exposure_start_date date
        drug_exposure_start_datetime datetime
        drug_exposure_end_date date
        drug_exposure_end_datetime datetime        
        drug_source_value varchar "drug code as represented in source"
        drug_source_value_name varchar "drug name as represented in source - may include formulation"
        domain_id varchar "most relevant omop domain"
        source_vocabulary_id varchar "id of source vocab"
        drug_type varchar "status of drug, prescribing_unknown, prescribing_administered, prescribing_notadministered"
        drug_location varchar "free text for location context - e.g. ward name or clinic name"
        drug_desc varchar "additional free text for further qualification, e.g. patient refused"
        route_source_value varchar "route as represented in the source"
        item_formulation_source_value varchar "best string that fully describes item formulation, particularly infusions: e.g. 10mg/ml propofol emulsion"       
        item_type_source_value varchar "type of item, e.g. emulsion"        
        dose_instruct_source_value varchar "best string that captures dosing, e.g. 100mg"
        dose_quantity_source_value float "dose prescribed e.g. 100"
        dose_unit_source_value varchar "units given to the prescribed dose e.g. mg"
        dose_frequency_source_value varchar "dosing instructions e.g. once stat"
        infusion_rate_source_value varchar "rate of infusion between start_datetime and end_datetime"
        infusion_rate_quantity_source_value float "rate of infusion as number"
        infusion_rate_unit_source_value varchar "rate of infusion units"
        stop_reason varchar "stop reason where given in source"
        sig varchar "additional verbatim instructions for drug"
        visit_occurrence_id integer "[FK ext_visit_occurrence] standardised unique visit id"
        source_table_provenance varchar "source table name"
        source_row_id uuid "unique row id for the single concept that is generated at ingestion"
    }
```

### silver.ext_drug_exposure (SILVER)

This is the transformed version of ingested drug_exposure tables. It includes dispensing and administration (specified through `drug_type`). Concepts in this table are mapped to OMOP standards, and column naming is compatible, but it contains the following differences:

- Mappings are made to OMOP at same granularity as original source value, as well as to the drug ingredient(s);
- Mapping is made by default to dm+d due to NHS/UK origin, with further mapping to RxNorm when transforming to vanilla OMOP;
- Standardised concept codes/names are surfaced, and indexed, to enable user-friendly exploration and visualisation without the need for large joins;
- OMOP CDM 5.4 columns that are not relevant to the NHS, or to intended purposes, are excluded. When converting to vanilla OMOP, these columns remain empty;
- Source, table, and systems provenance are maintained, and closest provenance type is mapped to `drug_type_concept_id` per OMOP;
- Greater granularity in strength, dose, and infusion characteristics are allowed.

```{mermaid}
---
title: OMOP_EXT Drug Exposure
---
erDiagram
    ext_drug_exposure {
        drug_exposure_id integer "[PK] autogenerated identifier"
        person_uuid uuid "[FK ext_person] standardised unique person id"
        drug_exposure_start_date date
        drug_exposure_start_datetime datetime
        drug_exposure_end_date date
        drug_exposure_end_datetime datetime  
        drug_concept_id integer "OMOP standard concept id"
        drug_concept_code varchar "OMOP standard concept code"
        drug_concept_name varchar "OMOP standard concept name"
        drug_vocabulary_id varchar "OMOP standard vocabulary" 
        drug_ingredient_concept_id integer "OMOP standard concept id for ingredient(s)"
        drug_ingredient_concept_code varchar "OMOP standard concept code for ingredient(s)"
        drug_ingredient_concept_name varchar "OMOP standard concept name for ingredient(s)"            
        drug_ingredient_vocabulary_id varchar "OMOP standard vocabulary for ingredient(s)"
        drug_type_concept_id integer "OMOP classification for type of drug record"                   
        drug_type varchar "status of drug - see previous notes"
        drug_location varchar "free text for location context"
        drug_desc varchar "additional free text for further qualification"
        route_concept_id integer "OMOP standard concept id for route"
        route_concept_name varchar "OMOP standard concept name for route"
        item_formulation_source_value varchar "if available, best string that fully describes strength/formulation/concentration"
        item_strength_quantity_source_value float "strength of one item of drug e.g. 500"
        item_strength_units_source_value varchar "units given to one item e.g. mg"        
        item_type_source_value varchar "type of item, e.g. tablet"
        dose_instruct_source_value varchar "if available, best string that captures dosing instructions, e.g. 1g four times a day"
        dose_quantity_source_value float "dose prescribed e.g. 1"
        dose_unit_source_value varchar "units given to the prescribed dose e.g. g"
        dose_frequency_source_value varchar "dosing instructions e.g. four times a day"
        infusion_rate_source_value varchar "if available, best string that captures rate of infusion between start_datetime and end_datetime"
        infusion_rate_quantity_source_value float "rate of infusion as number"
        infusion_rate_unit_source_value varchar "rate of infusion units"
        days_supply integer "how many days supply dispensed"
        stop_reason varchar "stop reason where given in source"
        sig varchar "additional verbatim instructions for drug"
        visit_occurrence_id integer "[FK ext_visit_occurrence] standardised unique visit id"
        drug_source_value varchar "drug code as represented in source"
        drug_source_value_name varchar "drug name as represented in source - may include formulation"     
        route_source_value varchar "route as represented in the source"           
        source_table_provenance varchar "source table name"
        source_row_id uuid "unique row id for the single concept that is generated at ingestion"
    }
```

### omop.drug_exposure (GOLD, OMOP CDM 5.4)

This table captures records about the exposure to a Drug ingested or otherwise introduced into the body. A Drug is a biochemical substance formulated in such a way that when administered to a Person it will exert a certain biochemical effect on the metabolism. Drugs include prescription and over-the-counter medicines, vaccines, and large-molecule biologic therapies. Radiological devices ingested or applied locally do not count as Drugs.

```{mermaid}
---
title: OMOP Drug Exposure
---
erDiagram
    drug_exposure {
        drug_exposure_id integer "[PK not null] autogenerated identifier"
        person_id integer "[FK not null]"
        drug_concept_id integer "[not null] standard OMOP concept id used for analyses, contains strength/dose info"
        drug_exposure_start_date date "[not null]"
        drug_exposure_start_datetime datetime
        drug_exposure_end_date date "[not null]"
        drug_exposure_end_datetime datetime
        verbatim_end_date date
        drug_type_concept_id integer "[not null] e.g. prescriptions / dispensed / patient reported"
        stop_reason varchar20 "reason for stopping as per source"
        refills integer
        quantity float "any numerical value for amount of drug"
        days_supply integer
        sig varcharMAX "verbatim instructions for drug"
        route_concept_id integer "standard omop concept id in route domain"
        lot_number varchar50
        provider_id integer "[FK] clinician provider who recorded condition"
        visit_occurrence_id integer "[FK]"
        visit_detail_id integer "[FK]"
        drug_source_value varchar50 "drug code as represented in source"
        drug_source_concept_id integer "source mapped to omop but often left empty"
        route_source_value varchar50 "verbatim route given in source"
        dose_unit_source_value varchar50 "verbatim units given in source"
    }
```

### ADDITIONAL NOTES

None for now!

### OUTSTANDING ISSUES

- Consider splitting out new table `silver.ext_drug_exposure_ingredient` as normalised lookup for multi-ingredient drugs that don't have easy dm+d equivalent.
